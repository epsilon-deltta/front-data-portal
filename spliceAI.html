<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="img/dna2.png">
    <title>Data portal</title>
 
    <!-- security-policy -->
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <!-- jquery -->
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <!-- 합쳐지고 최소화된 최신 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
 
    <!--conflict with jquery -->
    <!-- <link rel="stylesheet" href="https://cdn.datatables.net/t/bs-3.3.6/jqc-1.12.0,dt-1.10.11/datatables.min.css"/> 
    <script src="https://cdn.datatables.net/t/bs-3.3.6/jqc-1.12.0,dt-1.10.11/datatables.min.js"></script> -->
    <!-- Load c3.css -->
    <!-- Load d3.js and c3.js -->
    <!-- <link href="/c3-0.7.20/c3.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="/c3-0.7.20/c3.min.js"></script> -->
    <!-- dataTables -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.min.css" />

    <!-- components -->
    <link rel="stylesheet" href="./css/load.css" />
    <link rel="stylesheet" href="./css/clipboard.css" />
</head>

<body style="background-color: ;">
    <!-- javascript -->
    <script src="./js/loading.js"></script>
    <script src="./test_deploy.js"></script>
    <h2><a href='/index.html'>Data portal</a></h2>
    <!-- <navigation> -->
    <ul class="nav nav-tabs">
        <li role="presentation"><a href="./index.html">Home</a></li>
        <li role="presentation"><a href="./hexamer_test.html">Hexamer_track</a></li>
        <li role="presentation" class="active"><a href="./spliceAI.html">SpliceAI</a></li>
        <!-- <li role="presentation"><a href="#">Messages</a></li> -->
    </ul>
    <!-- </navigation> -->
    <div class="input-group center-block" style="width: 60%;">
        <input id="seq" type="text" class="form-control"
            placeholder="Enter ex)11:108236168-108236168 , 11:108236168 a>g, 11:108236164 GTTCA>G"
            onkeypress="javascript:if(event.keyCode == 13){sendSeq()}">
        <span class="input-group-btn">
            <button class="btn btn-secondary" type="button" onclick="sendSeq()">Run</button>
            <div class="btn-group">
                <button type="button" class="btn dropdown-toggle btn-primary" data-toggle="dropdown"
                    aria-expanded="false">
                    Examples <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <li><a onclick="javascript:insert_Into_input();sendSeq()">11:108236168-108236168</a></li>
                    <li><a onclick="javascript:insert_Into_input();sendSeq()">11:108236168</a></li>
                    <li><a onclick="javascript:insert_Into_input();sendSeq()">11:108236168 a>g</a></li>
                    <li><a onclick="javascript:insert_Into_input();sendSeq()">11:108236164 GTTCA>G</a></li>
                    <li><a onclick="javascript:insert_Into_input();sendSeq()">NM_000552:3797</a></li>
                    <li><a onclick="javascript:insert_Into_input();sendSeq()">NM_000552.4(VWF):c.3797T>A</a></li>
                    <li class="divider"></li>
                    <li><a onclick="openWindow()">Guide</a></li>
                </ul>
            </div>
            <button style="background-color: ;" type="button" class="btn btn-info" onclick="cleanInput();clean_list()">Clean</button>
        </span>
    </div>

    <!-- =============== -->
    <!-- <loading> -->
    <div class="load_div">
        <div class='wrapper'>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
            <i></i>
        </div>
        <div id="load">
            <div>G</div>
            <div>N</div>
            <div>I</div>
            <div >D</div>
            <div>A</div>
            <div>O</div>
            <div>L</div>
        </div>
    </div>
    <!-- </loading>   -->
    <!-- ============== -->
    <h5 id="seq_text"></h5>
    <!-- ======================================= -->
    <ul id="splice" class="list-group">
        <!-- <li class="list-group-item">Cras justo odio</li> -->
        <!-- <li class="list-group-item">Dapibus ac facilisis in</li> -->
        <!-- <li class="list-group-item">Morbi leo risus</li> -->
        <!-- <li class="list-group-item">Porta ac consectetur ac</li> -->
        <!-- <li class="list-group-item">Vestibulum at eros</li> -->
    </ul>
    <!-- ==========================  -->
    <input id="clip-box" />
    <!-- ========================= -->
    <!-- ======================================= -->
    <img id="track_img">
    <h5 id="test"></h5>
    <div id="chart"></div>
    <div id="chart0"></div>
    <div id="chart1"></div>

    <script src=".\graph\percent.js"></script>
    <script>
        $("#seq").focus();
        function insert_Into_input() {
            $("#seq").val($(event.target).text());
        }
        function sendSeq() {
            var seq = $("#seq").val();
            if (seq == '') {
                alert("Enter sequence first!! 😜");
                return null
            }
            get_splice_data(seq);
        }


        // 11:108236168-108236168
        function get_splice_data(seq) {
            $("#splice").empty();
            track_data = {};
            $.ajax({
                type: "post",
                // async: false,
                url: "http://" + server_ip + ":" + back_port + "/seq/spliceai",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify({ "seq": seq }),
                timeout: 7000,
                success: function (received_data) {
                    show_splice_data(received_data);
                },
                error: function () {
                    alert("requesting to server is failed ....");
                },
                beforeSend: function () {
                    loading(true);
                },
                complete: function () {
                    loading(false);
                }

            });
        }
        function get_mas_hex_data(seq, tag) {
            // $("#splice").empty();
            // track_data = {};
            $.ajax({
                type: "post",
                // async: false,
                url: "http://" + server_ip + ":" + back_port + "/seq/hex_mas",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify({ "seq": seq }),
                timeout: 8000,
                success: function (received_data) {
                    show_hex_mas_data(received_data, tag);
                },
                error: function () {
                    alert("requesting to server is failed ....");
                },
                beforeSend: function () {
                    loading(true);
                },
                complete: function () {
                    loading(false);
                }

            });
        }
        var vep;
        // { "variants" : ["21  26960070  rs116645811 G A . . .", "21  26965148  rs1135638 G A . . ." ] }
        function get_vep_data(seq, tag) {
            // $("#splice").empty();
            // track_data = {};
            $.ajax({
                type: "post",
                // async: false,
                url: "http://" +server_ip + ":"+vep_port ,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify({ "seq": seq }),
                timeout: 8000,
                success: function (received_data) {
                    show_vep_data(received_data,tag);
                    // show_vep_data(received_data,tag);
                    // show_hex_mas_data(received_data,tag);
                },
                error: function () {
                    alert("requesting to server is failed ....");
                },
                beforeSend: function () {
                    loading(true);
                },
                complete: function () {
                    loading(false);
                }

            });
        }
        function get_vep_data_ensemble(seq, tag) {
            // $("#splice").empty();
            // track_data = {};
            server = "https://rest.ensembl.org";
            ext = "/vep/homo_sapiens/region";
            $.ajax({
                type: "post",
                // async: false,
                url: server + ext,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify({ "variants": ["21  26960070  rs116645811 G A . . .", "21  26965148  rs1135638 G A . . ."] }),
                timeout: 8000,
                success: function (received_data) {
                    show_vep_data(received_data,tag);
                    // show_vep_data(received_data,tag);
                    // show_hex_mas_data(received_data,tag);
                },
                error: function () {
                    alert("requesting to server is failed ....");
                },
                beforeSend: function () {
                    loading(true);
                },
                complete: function () {
                    loading(false);
                }

            });
        }

        // 
        // #output :[ {'chrN': '11', 'pos': 108236168, 'ref': 'AGTAG', 'alt': 'A', 'geneName': 'ATM', 'score': {'AG': 0.0, 'AL': 0.0, 'DG': 0.02, 'DL': 0.09}, 'relPos': {'AG': 49, 'AL': 0, 'DG': -48, 'DL': 0}},..]
        function show_splice_data(track_data) {
            // $("#track_img").attr('src', 'data:image/png;base64,' + track_data['base64']);
            // track_data = track_data;
            // console.log(track_data)
            for (var i = 0; i < track_data.length; i++) {
                nt_info = track_data[i]['chrN'] + ':' + track_data[i]['pos'] + " " + track_data[i]['ref'] + ">" + track_data[i]['alt'];

                splice_info =
                    "GeneName : " + track_data[i]['geneName'] + '<br>' +
                    "score : " + "AG :" + track_data[i]['score']['AG'] + "  AL :" + track_data[i]['score']['AL'] + "  DG :" + track_data[i]['score']['DG'] + "  DL: " + track_data[i]['score']['DL'] + '<br> ' +
                    "Relpos : " + "AG :" + track_data[i]['relPos']['AG'] + "  AL :" + track_data[i]['relPos']['AL'] + "  DG :" + track_data[i]['relPos']['DG'] + "  DL: " + track_data[i]['relPos']['DL'] + '\n';



                // nt_info : 11:12345678 A>G
                $("#splice").append("<li id='" + i + "nt' class='list-group-item'><span id='" + i + "nt_info'>" + nt_info + "</span></li>");
                // button_registration
                $("#" + i + "nt").append("<button type='button' class='btn btn-success btn-sm max_scan' >Maxent_Scan</button>");
                $("#" + i + "nt").append("<button type='button' class='btn btn-primary btn-sm vep' >VEP</button>");
                $("#" + i + "nt").append("<button type='button' class='btn btn-danger btn-sm ucsc' >Go to UCSC</button>");
                $("#" + i + "nt").append("<button type='button' class='btn btn-warning btn-sm gene' value="+track_data[i]['geneName']+">About Gene</button>");
                // splice_info table
                var score  = track_data[i]['score'];
                var relPos = track_data[i]['relPos'];
                $('#splice').append("<li class='list-group-item' id='" + i + "spli'></li>");
                $("#" + i + "spli").html(' <table id="' + i + 'sptab" class="table table-striped table-bordered" style="width:100%"> \
                            <thead>\
                                <tr>\
                                    <th></th>\
                                    <th>AG</th>\
                                    <th>AL</th>\
                                    <th>DG</th>\
                                    <th>DL</th>\
                                </tr>\
                            </thead>\
                            <tbody> \
                                <tr><td>Score</td><td>'+score['AG']+'</td><td>'+score['AL']+'</td><td>'+score['DG']+'</td><td>'+score['DL']+'</td></tr>\
                                <tr><td>Relpos</td><td>'+relPos['AG']+'</td><td>'+relPos['AL']+'</td><td>'+relPos['DG']+'</td><td>'+relPos['DL']+'</td></tr>\
                            </tbody> \
                            </table> \
                    ');
                // splice info
                $("#splice").append("<li class='list-group-item'>" + splice_info + "</li>");
                // copy function
                // $("#"+i+"nt").append("<button id='"+i+"cp' class='copy_nt' type='button' class='btn btn-default ' ><span class='glyphicon glyphicon-paperclip' aria-hidden='true'></span></button>");
                // $("#"+i+"cp").click(function(){copy(i+"nt") });
            };
            // $('.copy_nt').click()
            // event.target :button $(event.target).parent() : 
            $(".max_scan").on("click", function (event) {
                var btn_str = $(event.target).text();
                var nt_str  = $(event.target).parent().find("span").text();
                get_mas_hex_data(nt_str, event.target);
            });
            $(".vep").on("click", function (event) {
                var btn_str = $(event.target).text();
                var nt_str = $(event.target).parent().find("span").text();
                get_vep_data(nt_str, event.target);
            });
            $(".ucsc").on("click", function (event) {
                var btn_str = $(event.target).text();
                var nt_str = $(event.target).parent().find("span").text();
                console.log(nt_str);
                position = nt_str.split(' ')[0];
                console.log(position)
                window.open('https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg38&lastVirtModeType=default&lastVirtModeExtraState=&virtModeType=default&virtMode=0&nonVirtPosition=&position=' + position, "ucsc")
                // get_mas_hex_data(nt_str,event.target);
            });
            $(".gene").on("click", function (event) {
                var btn_str = $(event.target).text();
                var nt_str = $(event.target).parent().find("span").text();
                console.log(nt_str);
                position = nt_str.split(' ')[0];
                console.log(position)
                var gene = $(event.target).val();
                window.open('https://www.genecards.org/cgi-bin/carddisp.pl?gene=' + gene, "ucsc")
                // get_mas_hex_data(nt_str,event.target);
            });

        }
        function show_hex_mas_data(hex_mas, tag) {
            if (hex_mas['count']==0){
                lnc="It only has Long non coding(lnc) annotation";
                $(tag).parent().append("<li class='list-group-item'>" +lnc  + "</li>");
                return -1;
            }
            for (var i = 0; i < hex_mas['count']; i++) {

                nt_info = hex_mas[i]['transName'] + ' ' + hex_mas[i]['strand'] + '  :' + hex_mas[i]['type'] + '\n';

                hex_info = "Hexamer Info";

                hex = hex_mas[i]['hexamer'];
                hex_exon = "5p_exon :" + hex['5p_exon'] + " 3p_exon : " + hex['3p_exon'];
                hex_intron = "5p_intron :" + hex['5p_intron'] + " 3p_intron : " + hex['3p_intron'];
                hex_info = hex_info + "<br>" + hex_exon + "<br>" + hex_intron

                mas_info = "<h4>Maximum Entropy Scan (MaxEntScan)</h4>";
                mas = hex_mas[i]['mes'];
                if (hex_mas[i]['type'] == 'snv') {
                    nt_donor = "donor " + '<br>' +
                        'delta : ' + mas['donor']['delta'] + '<br>' +
                        'final : ' + mas['donor']['final'];
                    nt_acceptor = "acceptor " + '<br>' +
                        'delta : ' + mas['acceptor']['delta'] + '<br>' +
                        'final : ' + mas['acceptor']['final'];
                } else {
                    nt_donor = "donor " + '<br>' +
                        'ref : ' + mas['donor']['ref'] + '<br>' +
                        'alt : ' + mas['donor']['alt'];
                    nt_acceptor = "acceptor " + '<br>' +
                        'ref : ' + mas['acceptor']['ref'] + '<br>' +
                        'alt : ' + mas['acceptor']['alt'];
                }
                nt_mas = nt_donor + '<br>' + nt_acceptor;
                mas_info = mas_info + nt_mas;

                nt_total =
                    nt_info + '<br>' +
                    hex_info + '<br>' +
                    mas_info + '<br>';
                $(tag).parent().append("<li class='list-group-item'>" + nt_total + "</li>");
                // console.log($(tag).parent());
            }

            // alert(mas_total);


        }
// # output [{ ... } , { ... }]
// # ex_output [
//     {
//         "Uploaded_variation": "11_108236168_A/C",
//         "Location": "11:108236168",
//         "Allele": "C",
//         "Gene": "ENSG00000149311",
//         "Feature": "ENST00000278616",
//         "Feature_type": "Transcript",
//         "Consequence": "intron_variant",
//         "cDNA_position": "-",
//         "CDS_position": "-",
//         "Protein_position": "-",
//         "Amino_acids": "-",
//         "Codons": "-",
//         "Existing_variation": "-",
//         "Extra": {
//             "IMPACT": "MODIFIER",
//             "STRAND": "1",
//             "VARIANT_CLASS": "SNV",
//             "SYMBOL": "ATM",
//             "SYMBOL_SOURCE": "HGNC",
//             "HGNC_ID": "HGNC:795",
//             "BIOTYPE": "protein_coding",
//             "CANONICAL": "YES",
//             "TSL": "5",
//             "APPRIS": "P1",
//             "CCDS": "CCDS31669.1",
//             "ENSP": "ENSP00000278616",
//             "SWISSPROT": "Q13315",
//             "TREMBL": "A0A024R3C7",
//             "UNIPARC": "UPI000016B511",
//             "GENE_PHENO": "1",
//             "INTRON": "5/6"
//         }
//     },
        function show_vep_data(vep, tag) {
            var var_total='';
            for(var i =0;i<vep.length;i++){
                var var_info ='<div style="overflow:auto; background-color:lightblue"> \
                            <table   class="table" id="' + i + 'veptab" class="table table-striped table-bordered" style="width:100%"> \
                            <thead>\
                                <tr>\
                                    <th>Gene</th>\
                                    <th>Feature</th>\
                                    <th>Feature_Type</th>\
                                    <th>Consequence</th>\
                                    <th>cDNA</th>\
                                    <th>CDS_position</th>\
                                    <th>Protein_Position</th>\
                                    <th>Amino_Acid</th>\
                                    <th>Codons</th>\
                                    <th>Existing_variation</th>\
                                </tr>\
                            </thead>\
                            <tbody> \
                                <tr><td>'+vep[i]['Gene']+'</td><td>'+vep[i]['Feature']+'</td><td>'+vep[i]['Feature_type']+'</td><td>'+vep[i]['Consequence']+'</td><td>'+vep[i]['cDNA_position']+'</td><td>'+vep[i]['CDS_position']+'</td><td>'+vep[i]['Protein_position']+'</td><td>'+vep[i]['Amino_acids']+'</td><td>'+vep[i]['Codons']+'</td><td>'+vep[i]['Existing_variation']+'</td></tr>\
                            </tbody> \
                            </table> \
                            </div> \
                            ';
                var extra = vep[i]['Extra'];
                var var_extra = '';
                for (var item of Object.keys(extra) ){
                    console.log(item);
                    var_extra = var_extra + item+" : "+extra[item]+"<br>" ;
                }
                
                var_info   = var_info + var_extra;
                var_total += var_info;
            }
            
            // var_total = var_info;       
            $(tag).parent().append("<li style='background-color:' class='list-group-item'>"+ var_total + "</li>");
        }
        // $emsp;
        // function show_data(data,tag){
        //     // []
        //     var data_str;
        //     if data instanceof Array{
        //         for (let i = 0; i < array.length; i++) {

        //             data[i];

        //         }
        //     } // true
        //     // {}
        //     if data instanceof Object{

        //     }
        //     // string ,int
        //     return data 

        // }


        function jsonProcessor(jdata) {
            console.log(jdata['a']);
            console.log(jdata['g']);
            console.log(jdata['dna'].split(''))
        }
        function cleanInput() {
            $("#seq").val('');
        }
        function openWindow() {
            var new_win = window.open("./tool-guide.html", "Guide", "width=500,height=600");
        }
        function uploadFile() {
            var form = $('#FILE_FORM')[0];
            var formData = new FormData();
            formData.append("fileObj", $("#FILE_TAG")[0].files[0]);
            formData.append("fileObj2", $("#FILE_TAG2")[0].files[0]);
            $.ajax({
                url: 'http://127.0.0.1:8000/rna/',
                processData: false,
                contentType: false,
                dataType: 'json',
                data: formData,
                type: 'POST',
                success: function (result) {
                    showGraph(result);
                }
            });
        }
        function showGraph(result) {
            showPie(result);
            showDonut(result);
            showGuage(result);
        }
        function copy(id) {
            var copy_str = $(id).text();
            $("#clip-box").val(copy_str);
            $("#clip-box").select();
            document.execCommand('Copy');

        }
        function clean_list(){
            $('#splice').empty();
        }
        // setTimeout(function () {|
        //     chart.unload({
        //         ids: 'data1'
        //     });
        //     chart.unload({
        //         ids: 'data2'
        //     });
        // }, 2500);

    </script>
    <!-- <div style="background-color: powderblue;"></div> -->
    <script>


        // setTimeout(function () {
        //     chart.load({
        //         columns: [['data', 10]]
        //     });
        // }, 1000);

        // setTimeout(function () {
        //     chart.load({
        //         columns: [['data', 50]]
        //     });
        // }, 2000);

        // setTimeout(function () {
        //     chart.load({
        //         columns: [['data', 70]]
        //     });
        // }, 3000);

        // setTimeout(function () {
        //     chart.load({
        //         columns: [['data', 0]]
        //     });
        // }, 4000);

        // setTimeout(function () {
        //     chart.load({
        //         columns: [['data', 100]]
        //     });
        // }, 5000);
    </script>
</body>

</html>